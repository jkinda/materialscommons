<script type="text/ng-template" id="experiment-step.html">
    <div ui-tree-handle class="experiment-step tree-node-content" layout="row" layout-fill>
        <div layout="column">
            <i class="fa fa-fw fa-reorder"></i>
            <a data-nodrag ng-click="$ctrl.toggle(this)">
                <i class="fa fa-fw"
                   ng-class="{'fa-chevron-right': collapsed, 'fa-chevron-down': !collapsed}"></i>
            </a>
        </div>
        <md-card md-whiteframe data-nodrag
                 ng-class="{'step-selected': step.selected, 'current-step': step === $ctrl.currentStep}" flex>
            <md-card-header>
                <md-card-header-text layout="column">
                    <div layout="row" layout-align="space-between start">
                        <a flex="30" class="md-title" ng-click="$ctrl.toggleSelected(step)">
                            {{step.title | truncate:20:'...'}}
                        </a>
                        <a flex="10" ng-click="$ctrl.promptForRepeat(step)"><i class="fa fa-fw fa-repeat"></i></a>
                        <a class="md-warn" data-nodrag ng-click="$ctrl.remove(this)" style="color:#ff5824">
                            <i class="fa fa-fw fa-remove"></i>
                        </a>
                    </div>
                    <span class="md-subhead-light">{{step.description | truncate:40:'...'}}</span>
                </md-card-header-text>
            </md-card-header>
            <!--<img ng-if="step.image" ng-src="{{step.image}}" class="md-card-image">-->
            <!--<md-card-actions layout="row" layout-align="start center">-->
            <!--<a class="md-primary text-uppercase" data-nodrag ng-click="$ctrl.newStep(this)">-->
            <!--<i class="fa fa-fw fa-plus"></i> add child step-->
            <!--</a>-->
            <!--<span flex></span>-->
            <!--</md-card-actions>-->
        </md-card>
        <md-checkbox data-nodrag flex="10"></md-checkbox>
    </div>
    <ol ui-tree-nodes="" ng-model="step.steps" ng-class="{hidden: collapsed}">
        <li ng-repeat="step in step.steps" ui-tree-node ng-include="'experiment-step.html'">
        </li>
    </ol>
</script>

<div layout="row" layout-fill layout-margin layout-align="start start">
    <div layout="column" flex="100" layout-align="start stretch" md-whiteframe>
        <md-toolbar style="background-color: white" flex="100">
            <div layout="row" layout-align="start center"
                 style="background-color:#e9e9e9; padding-left:8px; padding-right:8px">
                <md-input-container md-no-float style="margin-top: 5px; margin-bottom:5px" flex="40">
                    <input type="text" ng-model="$ctrl.query" placeholder="SEARCH...">
                    <md-icon md-font-icon="fa-search" class="fa"
                             style="display:inline-block; color:grey; bottom: 23px"></md-icon>
                </md-input-container>
                <span flex></span>
                <a ng-click="$ctrl.showTableView = true"
                   ng-style="!$ctrl.showTableView && {'color': 'black'}">
                    <i class="fa fa-fw fa-th-list" style="margin-bottom: 15px"></i>
                </a>
                <a ng-click="$ctrl.showTableView = false"
                   ng-style="$ctrl.showTableView && {'color': 'black'}">
                    <i class="fa fa-fw fa-th" style="margin-bottom: 15px"></i>
                </a>
            </div>
        </md-toolbar>
    </div>
</div>

<div layout="row" layout-fill layout-margin layout-align="start start">
    <md-content flex="25">
        <div layout="column">
            <h3>Experiment</h3>
            <md-input-container md-no-float>
                <input type="text" placeholder="Name your experiment..." ng-model="$ctrl.experiment.name">
            </md-input-container>
            <md-input-container md-no-float>
                <textarea placeholder="Description..." ng-model="$ctrl.experiment.description"></textarea>
            </md-input-container>
            <md-input-container md-no-float>
                <textarea placeholder="Goal..." ng-model="$ctrl.experiment.goal"></textarea>
            </md-input-container>
        </div>
    </md-content>
    <md-content flex>
        <div layout="column">
            <div layout="row" layout-align="space-between center">
                <div>
                    <md-button class="md-primary" ng-class="{'md-hue-2': $ctrl.addHeadings}"
                               ng-click="$ctrl.addHeadings = true; $ctrl.addProcesses = false">
                        Add Headings
                    </md-button>
                    <md-button class="md-primary" ng-class="{'md-hue-2': $ctrl.addProcesses}"
                               ng-click="$ctrl.addProcesses = true; $ctrl.addHeadings = false">
                        Add Processes
                    </md-button>
                </div>
                <div>
                    <md-button class="md-primary" ng-click="$ctrl.expandAll()">Expand all</md-button>
                    <md-button class="md-warn" ng-click="$ctrl.collapseAll()">Collapse all</md-button>
                </div>
            </div>

            <div ng-if="$ctrl.addProcesses" style="margin-top: 9px; margin-bottom: 18px">
                <md-autocomplete md-selected-item="$ctrl.selectedProcess"
                                 md-item-text="process.name"
                                 md-items="process in $ctrl.getMatches(searchText)"
                                 md-selected-item-change="$ctrl.addProcess()"
                                 md-delay="200"
                                 md-no-cache="true"
                                 placeholder="Choose process..."
                                 on-enter="$ctrl.addProcess()"
                                 md-search-text="$ctrl.searchText">
                    <md-item-template>
                        <span md-highlight-text="$ctrl.searchText">{{process.name}}</span>
                    </md-item-template>
                    <md-not-found>
                        Unknown process {{$ctrl.searchText}}
                        <a ng-click="$ctrl.newProcessEntry($ctrl.searchText)">Click to create new process type</a>
                    </md-not-found>
                </md-autocomplete>
            </div>
            <md-input-container ng-if="$ctrl.addHeadings" md-no-float style="margin-bottom:0">
                <input type="text" on-enter="$ctrl.addHeading()"
                       ng-model="$ctrl.heading" placeholder="Add heading...">
            </md-input-container>
            <div layout="row" layout-align="space-between start" layout-fill style="margin-bottom: 20px;">
                <div class="md-subhead-light">
                    Adding at <span style="color:#1565c0">{{$ctrl.selectedStep ? $ctrl.selectedStep.title : 'Top level'}}</span>
                </div>

                <div class="md-subhead-light">
                    Editing <span style="color: #ff5824">{{$ctrl.currentStep ? $ctrl.currentStep.title : 'None'}}</span>
                </div>
            </div>
            <div layout="column">
                <div ui-tree id="tree-root" ng-if="$ctrl.experiment.steps.length">
                    <ol ui-tree-nodes ng-model="$ctrl.experiment.steps">
                        <li ng-repeat="step in $ctrl.experiment.steps" ui-tree-node
                            ng-include="'experiment-step.html'"></li>
                    </ol>
                </div>
            </div>
        </div>
    </md-content>
    <span flex="5"></span>
    <md-content flex="30" layout="column">
        <div layout="row" layout-align="center start">
            <h3>Details</h3>
        </div>
        <div ng-if="$ctrl.currentStep">
            <form>
                <md-input-container class="md-block" flex>
                    <label>Title</label>
                    <input type="text" ng-model="$ctrl.currentStep.title">
                </md-input-container>
                <md-input-container class="md-block">
                    <label>Description</label>
                    <textarea ng-model="$ctrl.currentStep.description"></textarea>
                </md-input-container>
            </form>
        </div>
    </md-content>
</div>